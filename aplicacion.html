<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evaluaci칩n - Plataforma de Funciones</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Estilos espec칤ficos para la p치gina de evaluaci칩n */
        #reto-container {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            text-align: center;
        }

        .graficas-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            width: 100%;
            flex-wrap: wrap;
        }
        
        #reto-chart, #user-chart {
            width: 400px;
            height: 400px;
            margin-bottom: 20px;
        }
        
        #reto-message {
            margin-top: 20px;
            font-weight: bold;
            font-size: 1.2em;
        }

        .correct {
            color: green;
        }

        .incorrect {
            color: red;
        }

        /* Estilos para la barra de navegaci칩n de retos */
        #reto-nav {
            margin: 20px auto;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        #reto-nav a {
            padding: 8px 16px;
            border: 1px solid #ccc;
            border-radius: 5px;
            text-decoration: none;
            color: #333;
            background-color: #f9f9f9;
        }

        #reto-nav a.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }

        #reto-nav a.completed {
            background-color: #28a745;
            color: white;
            border-color: #28a745;
        }

        #reto-nav a.disabled {
            pointer-events: none;
            opacity: 0.5;
        }
    </style>
</head>
<body>

    <nav class="nav-dots">
        <ul>
            <li><a href="index.html">1</a></li>
            <li><a href="teoria.html">2</a></li>
            <li><a href="grafico.html">3</a></li>
            <li><a href="aplicacion.html" class="active">4</a></li>
            <li><a href="evaluacion.html">5</a></li>
        </ul>
    </nav>

    <main>
        <div class="content-page">
            <h2>Evaluaci칩n - Adivina la Gr치fica</h2>
            <p>Usa los bloques para crear la funci칩n que corresponde a la gr치fica que se muestra. Cuando creas que es correcta, presiona "Evaluar".</p>

            <div id="reto-nav"></div>
            <h3 id="reto-title"></h3>

            <div id="reto-container">
                <div class="graficas-container">
                    <div>
                        <h4>Gr치fica del Reto</h4>
                        <div id="reto-chart"></div>
                    </div>
                    <div id="user-chart-container" style="display: none;">
                        <h4>Tu Gr치fica</h4>
                        <div id="user-chart"></div>
                    </div>
                </div>

                <div id="reto-message"></div>
                
                <div id="blocklyDiv" style="height: 400px; width: 100%;"></div>
                
                <button onclick="evaluarReto()" class="action-btn">Evaluar</button>
            </div>
        </div>
    </main>

    <script src="https://www.google.com/jsapi"></script>
    <script src="./node_modules/blockly/blockly_compressed.js"></script>
    <script src="./node_modules/blockly/blocks_compressed.js"></script>
    <script src="./node_modules/blockly/javascript_compressed.js"></script>
    <script src="./node_modules/blockly/msg/en.js"></script>

    <xml xmlns="https://developers.google.com/blockly/xml" id="startBlocks" style="display: none">
        <block type="graph_set_y1" deletable="false" x="100" y="100">
            <value name="VALUE">
                <block type="math_number">
                    <field name="NUM">0</field>
                </block>
            </value>
        </block>
    </xml>
    
    <script>
        // Hemos a침adido propiedades de ploteo y visualizaci칩n a cada reto
        const retos = [
            {
                formula: 'x + 4',
                nombre: 'Funci칩n Lineal',
                plotXMin: -10, plotXMax: 10,
                viewXMin: -10, viewXMax: 10,
                viewYMin: -10, viewYMax: 10,
                bloques: '<block type="math_arithmetic"><field name="OP">ADD</field><value name="A"><block type="graph_get_x"></block></value><value name="B"><block type="math_number"><field name="NUM">4</field></block></value></block>'
            },
            {
                formula: 'Math.pow(x, 2) + 6',
                nombre: 'Funci칩n Cuadr치tica',
                plotXMin: -20, plotXMax: 20,
                viewXMin: -10, viewXMax: 10,
                viewYMin: 0, viewYMax: 100,
                bloques: '<block type="math_arithmetic"><field name="OP">ADD</field><value name="A"><block type="math_arithmetic"><field name="OP">POWER</field><value name="A"><block type="graph_get_x"></block></value><value name="B"><block type="math_number"><field name="NUM">2</field></block></value></block></value><value name="B"><block type="math_number"><field name="NUM">6</field></block></value></block>'
            },
            {
                formula: 'Math.sqrt(x)',
                nombre: 'Funci칩n Ra칤z Cuadrada',
                plotXMin: 0, plotXMax: 20,
                viewXMin: 0, viewXMax: 20,
                viewYMin: 0, viewYMax: 10,
                bloques: '<block type="math_single"><field name="OP">ROOT</field><value name="NUM"><block type="graph_get_x"></block></value></block>'
            },
            {
                formula: 'Math.pow(x, 3) + 2',
                nombre: 'Funci칩n C칰bica',
                plotXMin: -10, plotXMax: 10,
                viewXMin: -10, viewXMax: 10,
                viewYMin: -100, viewYMax: 100,
                bloques: '<block type="math_arithmetic"><field name="OP">ADD</field><value name="A"><block type="math_arithmetic"><field name="OP">POWER</field><value name="A"><block type="graph_get_x"></block></value><value name="B"><block type="math_number"><field name="NUM">3</field></block></value></block></value><value name="B"><block type="math_number"><field name="NUM">2</field></block></value></block>'
            },
            {
                formula: 'x - 5 / x',
                nombre: 'Funci칩n Racional',
                plotXMin: -10, plotXMax: 10,
                viewXMin: -10, viewXMax: 10,
                viewYMin: -20, viewYMax: 20,
                bloques: '<block type="math_arithmetic"><field name="OP">MINUS</field><value name="A"><block type="graph_get_x"></block></value><value name="B"><block type="math_arithmetic"><field name="OP">DIVIDE</field><value name="A"><block type="math_number"><field name="NUM">5</field></block></value><value name="B"><block type="graph_get_x"></block></value></block></value></block>'
            }
        ];

        let retoActual = 0;
        let retosCompletados = 0;
        let workspace = null;
        let messageDiv;
        let userChartContainer;
        let retoTitle;

        const toolbox = {
            kind: 'categoryToolbox',
            contents: [
                { kind: 'category', name: 'Matem치ticas', colour: '%{BKY_MATH_HUE}', contents: [{ kind: 'block', type: 'math_number' }, { kind: 'block', type: 'math_arithmetic' }, { kind: 'block', type: 'math_single' }, { kind: 'block', type: 'math_trig' }, { kind: 'block', type: 'math_constant' }] },
                { kind: 'category', name: 'Variables', colour: '%{BKY_VARIABLES_HUE}', contents: [{ kind: 'block', type: 'graph_get_x' }, { kind: 'block', type: 'graph_set_y1' }] },
            ],
        };

        Blockly.defineBlocksWithJsonArray([
            { type: 'graph_get_x', message0: 'x', output: 'Number', colour: Blockly.Msg['VARIABLES_HUE'] },
            { type: 'graph_set_y1', message0: 'y = %1', args0: [{ type: 'input_value', name: 'VALUE', check: 'Number' }], colour: Blockly.Msg['VARIABLES_HUE'] },
        ]);
        javascript.javascriptGenerator.forBlock['graph_get_x'] = function (block) { return ['x', javascript.Order.ATOMIC]; };
        javascript.javascriptGenerator.forBlock['graph_set_y1'] = function (block, generator) {
            block.setDeletable(false);
            var argument0 = generator.valueToCode(block, 'VALUE', javascript.Order.ASSIGNMENT) || '0';
            return 'y1 = ' + argument0 + ';';
        };

        /**
         * Genera los puntos para la gr치fica a partir de una f칩rmula y un rango de x.
         * @param {string} formula La f칩rmula matem치tica como una cadena de texto.
         * @param {number} xMin El valor m칤nimo del eje X para el c치lculo.
         * @param {number} xMax El valor m치ximo del eje X para el c치lculo.
         * @returns {Array<Array>} Tabla de datos para Google Charts.
         */
        function plotGraph(formula, xMin, xMax) {
            let table = [['x', 'y']];
            for (let x = xMin; x <= xMax; x = Math.round((x + 0.1) * 10) / 10) {
                let y;
                try {
                    const f = new Function('x', `return ${formula};`);
                    y = f(x);
                } catch (e) {
                    y = NaN;
                }
                if (!isNaN(y)) {
                    y = Math.round(y * Math.pow(10, 14)) / Math.pow(10, 14);
                    table.push([x, y]);
                }
            }
            if (table.length === 1) table.push([0, 0]);
            return table;
        }

        function evaluarReto() {
            const reto = retos[retoActual];
            const formulaAlumnoRaw = javascript.javascriptGenerator.workspaceToCode(workspace);
            const formulaAlumno = formulaAlumnoRaw.replace(/y1\s*=\s*/, '').replace(/;$/, '').trim();

            // Usamos los rangos de ploteo definidos en el reto
            const dataUsuario = google.visualization.arrayToDataTable(plotGraph(formulaAlumno, reto.plotXMin, reto.plotXMax));
            userChartContainer.style.display = 'block';

            // Usamos los rangos de visualizaci칩n definidos en el reto para la gr치fica del usuario
            const userChartOptions = {
                hAxis: { title: 'x', viewWindow: { min: reto.viewXMin, max: reto.viewXMax } },
                vAxis: { title: 'y', viewWindow: { min: reto.viewYMin, max: reto.viewYMax } },
                legend: { position: 'none' },
                series: { 0: { color: 'blue' } }
            };

            new google.visualization.LineChart(
                document.getElementById('user-chart')
            ).draw(dataUsuario, userChartOptions);

            const puntosReto = plotGraph(reto.formula, reto.plotXMin, reto.plotXMax);
            const puntosAlumno = plotGraph(formulaAlumno, reto.plotXMin, reto.plotXMax);
            
            const sonIguales = JSON.stringify(puntosReto.map(p => p.map(n => Math.round(n * 1000) / 1000))) === JSON.stringify(puntosAlumno.map(p => p.map(n => Math.round(n * 1000) / 1000)));

            messageDiv.className = '';

            if (sonIguales) {
                messageDiv.textContent = `춰Correcto! Has adivinado la funci칩n. 游꿀`;
                messageDiv.classList.add('correct');
                
                if (retoActual === retosCompletados) {
                    retosCompletados++;
                    localStorage.setItem('retosCompletados', retosCompletados);
                }
                
                setTimeout(siguienteReto, 2000);
            } else {
                messageDiv.textContent = 'Int칠ntalo de nuevo. La gr치fica no es la correcta.';
                messageDiv.classList.add('incorrect');
            }
        }
        
        function siguienteReto() {
            if (retoActual < retos.length - 1) {
                cargarReto(retoActual + 1);
            } else {
                messageDiv.textContent = '춰Felicidades! Has completado todos los retos.';
                messageDiv.classList.add('correct');
            }
            userChartContainer.style.display = 'none';
        }

        function cargarReto(index) {
            if (index > retosCompletados) {
                return;
            }

            retoActual = index;
            messageDiv.textContent = '';
            messageDiv.className = '';

            const reto = retos[retoActual];
            retoTitle.textContent = `Reto ${retoActual + 1}: ${reto.nombre}`;
            
            // Usamos los rangos de visualizaci칩n y ploteo definidos en el reto
            const dataReto = google.visualization.arrayToDataTable(plotGraph(reto.formula, reto.plotXMin, reto.plotXMax));
            const retoChartOptions = {
                hAxis: { title: 'x', viewWindow: { min: reto.viewXMin, max: reto.viewXMax } },
                vAxis: { title: 'y', viewWindow: { min: reto.viewYMin, max: reto.viewYMax } },
                legend: { position: 'none' },
                series: { 0: { color: 'green' } }
            };

            new google.visualization.LineChart(
                document.getElementById('reto-chart')
            ).draw(dataReto, retoChartOptions);

            workspace.clear();
            const startBlockXml = document.getElementById('startBlocks');
            Blockly.Xml.domToWorkspace(startBlockXml, workspace);

            userChartContainer.style.display = 'none';
            actualizarNavegacion();
        }

        function actualizarNavegacion() {
            const navDiv = document.getElementById('reto-nav');
            navDiv.innerHTML = '';

            for (let i = 0; i < retos.length; i++) {
                const link = document.createElement('a');
                link.href = '#';
                link.textContent = i + 1;
                link.onclick = (e) => {
                    e.preventDefault();
                    cargarReto(i);
                };

                if (i === retoActual) {
                    link.classList.add('active');
                }
                if (i < retosCompletados) {
                    link.classList.add('completed');
                }
                if (i > retosCompletados) {
                    link.classList.add('disabled');
                }

                navDiv.appendChild(link);
            }
        }

        function init() {
            messageDiv = document.getElementById('reto-message');
            userChartContainer = document.getElementById('user-chart-container');
            retoTitle = document.getElementById('reto-title');
            
            const savedProgress = localStorage.getItem('retosCompletados');
            if (savedProgress !== null) {
                retosCompletados = parseInt(savedProgress);
            }

            workspace = Blockly.inject('blocklyDiv', {
                media: './node_modules/blockly/media/',
                toolbox: toolbox,
            });
            
            cargarReto(retoActual);
            
            window.addEventListener('resize', () => Blockly.svgResize(workspace));
        }

        if (typeof google === 'object') {
            google.load('visualization', '1', { packages: ['corechart'] });
            google.setOnLoadCallback(init);
        }
    </script>
</body>
</html>