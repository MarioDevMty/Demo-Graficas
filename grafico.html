<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Blockly Demo: Graph</title>
    <script src="https://www.google.com/jsapi"></script>
    <script src="./node_modules/blockly/blockly_compressed.js"></script>
    <script src="./node_modules/blockly/blocks_compressed.js"></script>
    <script src="./node_modules/blockly/javascript_compressed.js"></script>
    <script src="./node_modules/blockly/msg/en.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intro.js/7.2.0/introjs.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/intro.js/7.2.0/intro.min.js"></script>
    <style>
      .intro-image-container {
        display: none;
        width: 100%;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        box-sizing: border-box;
      }
      .intro-image-container img {
        width: 100%;
        height: auto;
        border: 2px solid #3498db;
        border-radius: 8px;
      }
      .examples-container {
        margin-top: 20px;
        padding: 20px;
        background-color: #f0f4f8;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        text-align: center;
      }
      .example {
        display: none; /* Por defecto, todos los ejemplos están ocultos */
        margin-bottom: 20px;
        padding: 15px;
        background-color: #ffffff;
        border: 1px solid #e0e6ed;
        border-radius: 8px;
      }
      .example.active {
          display: block; /* Muestra el ejemplo activo */
      }
      .example-title {
        font-size: 1.2em;
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 10px;
      }
      .example-blocks img {
        max-width: 100%;
        height: auto;
      }

      /* Estilos para la nueva barra de navegación de ejemplos */
      .example-nav {
          display: flex;
          justify-content: center;
          margin-bottom: 20px;
      }
      .example-nav button {
          background-color: #fff;
          border: 1px solid #ddd;
          border-radius: 50%;
          width: 40px;
          height: 40px;
          margin: 0 5px;
          font-size: 1em;
          font-weight: bold;
          cursor: pointer;
          transition: background-color 0.3s, transform 0.2s;
      }
      .example-nav button.active, .example-nav button:hover {
          background-color: #3498db;
          color: #fff;
          transform: scale(1.1);
      }
    </style>
  </head>
  <body>
    <nav class="nav-dots">
        <ul>
            <li><a href="index.html" >1</a></li>
            <li><a href="teoria.html">2</a></li>
            <li><a href="grafico.html" class="active">3</a></li>
            <li><a href="aplicacion.html">4</a></li>
            <li><a href="evaluacion.html">5</a></li>
        </ul>
    </nav>
    <p>
      Programa la función que quieras representar en el área de la gráfica
    </p>
    <p>
      &rarr; Puedes usar las variables y los operadores matemáticos básicos.
    </p>

    <button onclick="startTutorial()" class="tutorial-btn">Iniciar Tutorial</button>

    <div id="tutorial-intro-container" class="intro-image-container" data-intro="¡Bienvenido al tutorial! Primero, analizaremos la interfaz para que te familiarices con las áreas de trabajo." data-step="1">
        <img src="assets/blockly-tour.png" alt="Área de trabajo de Blockly">
        <p>
          1. **Caja de Herramientas:** Los bloques de programación están en el lado izquierdo.
          <br>2. **Área de Programación:** En el centro, es donde creas tu función.
          <br>3. **Área de la Gráfica:** En el lado derecho, donde ves el resultado de tu código.
        </p>
    </div>
    
    <hr>
    
    <table>
      <tr>
        <td id="blocklyTd">
          <div id="blocklyDiv" style="height: 400px" data-intro="En este espacio puedes arrastrar y unir los bloques de la caja de herramientas para construir tu función." data-step="2"></div>
        </td>
        <td id="graphTd">
          <div id="visualization" style="width: 400px" data-intro="Aquí se mostrará la gráfica de la función que programes. ¡Verás los resultados en tiempo real!" data-step="3"></div>
        </td>
      </tr>
    </table>
    
    <div class="examples-container">
        <h2>Ejemplos para Emular</h2>
        
        <div class="example-nav" data-intro="Usa estos botones para navegar entre los diferentes ejemplos. Observa cada uno y trata de replicarlo en el área de trabajo de Blockly." data-step="4">
            <button onclick="showExample(1)" class="active">1</button>
            <button onclick="showExample(2)">2</button>
            <button onclick="showExample(3)">3</button>
            <button onclick="showExample(4)">4</button>
            <button onclick="showExample(5)">5</button>
        </div>
        
        <div class="examples-content-wrapper">
            <div id="example-1" class="example active">
                <div class="example-title">Función: $y = x^2 + 5$</div>
                <div class="example-blocks">
                    <img src="assets/y=x^2+5.png" alt="Bloques para y=x^2+5">
                </div>
            </div>

            <div id="example-2" class="example">
                <div class="example-title">Función: $y = x - 2$</div>
                <div class="example-blocks">
                    <img src="assets/y=x-2.png" alt="Bloques para y=x-2">
                </div>
            </div>

            <div id="example-3" class="example">
                <div class="example-title">Función: $y = \frac{2}{3}x + 1$</div>
                <div class="example-blocks">
                    <img src="assets/y=23x+1.png" alt="Bloques para y=2/3x+1">
                </div>
            </div>
            
            <div id="example-4" class="example">
                <div class="example-title">Función: $y = \sqrt{x}$</div>
                <div class="example-blocks">
                    <img src="assets/y=sqrtx.png" alt="Bloques para y=sqrt(x)">
                </div>
            </div>
            
            <div id="example-5" class="example">
                <div class="example-title">Función: $y = x^3 + 2$</div>
                <div class="example-blocks">
                    <img src="assets/y=x^3+2.png" alt="Bloques para y=x^3+2">
                </div>
            </div>
        </div>
    </div>
    
    <script>
      // Load the Google Chart Tools Visualization API and the chart package.
      if (typeof google == 'object') {
        google.load('visualization', '1', {packages: ['corechart']});
      } else {
        alert(
          "Unable to load Google's chart API.\n" +
            'Are you connected to the Internet?',
        );
      }

      // Define the toolbox
      const toolbox = {
        kind: 'categoryToolbox',
        contents: [
          {
            kind: 'category',
            name: 'Matemáticas, Valores y operadores',
            id: 'mathCategory',
            colour: '%{BKY_MATH_HUE}',
            contents: [
              {
                kind: 'block',
                type: 'math_number',
                fields: {
                  NUM: 123,
                },
              },
              {
                kind: 'block',
                type: 'math_arithmetic',
                inputs: {
                  A: {
                    shadow: {
                      type: 'math_number',
                      fields: {
                        NUM: 1,
                      },
                    },
                  },
                  B: {
                    shadow: {
                      type: 'math_number',
                      fields: {
                        NUM: 1,
                      },
                    },
                  },
                },
              },
              {
                kind: 'block',
                type: 'math_single',
                inputs: {
                  NUM: {
                    shadow: {
                      type: 'math_number',
                      fields: {
                        NUM: 9,
                      },
                    },
                  },
                },
              },
              {
                kind: 'block',
                type: 'math_trig',
                inputs: {
                  NUM: {
                    shadow: {
                      type: 'math_number',
                      fields: {
                        NUM: 45,
                      },
                    },
                  },
                },
              },
              {
                kind: 'block',
                type: 'math_constant',
              },
              {
                kind: 'block',
                type: 'math_atan2',
                inputs: {
                  X: {
                    shadow: {
                      type: 'math_number',
                      fields: {
                        NUM: 1,
                      },
                    },
                  },
                  Y: {
                    shadow: {
                      type: 'math_number',
                      fields: {
                        NUM: 1,
                      },
                    },
                  },
                },
              },
              {
                kind: 'block',
                type: 'math_fraction',
              },
            ],
          },
          {
            kind: 'category',
            name: 'Variables',
            id: 'variablesCategory',
            colour: '%{BKY_VARIABLES_HUE}',
            contents: [
              {
                kind: 'block',
                type: 'graph_get_x',
              }
            ],
          },
          {
            kind: 'category',
            name: 'Logic',
            id: 'logicCategory',
            colour: '%{BKY_LOGIC_HUE}',
            contents: [
              {
                kind: 'block',
                type: 'logic_compare',
              },
              {
                kind: 'block',
                type: 'logic_operation',
              },
              {
                kind: 'block',
                type: 'logic_negate',
              },
              {
                kind: 'block',
                type: 'logic_boolean',
              },
              {
                kind: 'block',
                type: 'logic_ternary',
              },
            ],
          },
        ],
      };

      const startBlocks = {
        blocks: {
          blocks: [
            {
              kind: 'block',
              type: 'graph_set_y1',
              x: 100,
              y: 100,
              inputs: {
                VALUE: {
                  block: {
                    type: 'math_arithmetic',
                    fields: {
                      OP: 'POWER',
                    },
                    inputs: {
                      A: {
                        block: {
                          type: 'graph_get_x',
                          shadow: {
                            type: 'math_number',
                            fields: {
                              NUM: 1,
                            },
                          },
                        },
                      },
                      B: {
                        block: {
                          type: 'math_number',
                          fields: {
                            NUM: 2,
                          },
                          shadow: {
                            type: 'math_number',
                            fields: {
                              NUM: 1,
                            },
                          },
                        },
                      },
                    },
                  },
                },
              },
            },
          ],
        },
      };

      // Define the custom blocks and their JS generators.
      Blockly.defineBlocksWithJsonArray([
        {
          type: 'graph_get_x',
          message0: 'x',
          output: 'Number',
          colour: Blockly.Msg['VARIABLES_HUE'],
          tooltip: Blockly.Msg['VARIABLES_GET_TOOLTIP'],
          helpUrl: Blockly.Msg['VARIABLES_GET_HELPURL'],
        },
      ]);

      javascript.javascriptGenerator.forBlock['graph_get_x'] = function (
        block,
      ) {
        return ['x', javascript.Order.ATOMIC];
      };

      Blockly.defineBlocksWithJsonArray([
        {
          type: 'graph_set_y1',
          message0: 'y = %1',
          args0: [
            {
              type: 'input_value',
              name: 'VALUE',
              check: 'Number',
            },
          ],
          colour: Blockly.Msg['VARIABLES_HUE'],
          tooltip: Blockly.Msg['VARIABLES_SET_TOOLTIP'],
          helpUrl: Blockly.Msg['VARIABLES_SET_HELPURL'],
        },
      ]);

      javascript.javascriptGenerator.forBlock['graph_set_y1'] = function (
        block,
        generator,
      ) {
        block.setDeletable(false);
        var argument0 =
          generator.valueToCode(block, 'VALUE', javascript.Order.ASSIGNMENT) ||
          '0';
        return 'y1 = ' + argument0 + ';';
      };

      // Nuevo bloque para fracciones
      Blockly.defineBlocksWithJsonArray([
        {
          type: 'math_fraction',
          message0: 'fracción %1 / %2',
          args0: [
            {
              type: 'input_value',
              name: 'NUMERATOR',
              check: 'Number',
            },
            {
              type: 'input_value',
              name: 'DENOMINATOR',
              check: 'Number',
            },
          ],
          output: 'Number',
          colour: Blockly.Msg['MATH_HUE'],
          tooltip: 'Calcula el valor de una fracción.',
          helpUrl: '',
        },
      ]);

      javascript.javascriptGenerator.forBlock['math_fraction'] = function (block, generator) {
        var numerator = generator.valueToCode(block, 'NUMERATOR', javascript.Order.DIVISION) || '0';
        var denominator = generator.valueToCode(block, 'DENOMINATOR', javascript.Order.DIVISION) || '0';
        var code = '(' + numerator + ' / ' + denominator + ')';
        return [code, javascript.Order.DIVISION];
      };

      /**
       * Create a namespace for the application.
       */
      var Graph = {};

      /**
       * Main Blockly workspace.
       * @type {Blockly.WorkspaceSvg}
       */
      Graph.workspace = null;

      /**
       * Cached copy of the function string.
       * @type {?string}
       * @private
       */
      Graph.oldFormulas_ = null;

      /**
       * Drawing options for the Chart API.
       * @type {!Object}
       * @private
       */
      Graph.options_ = {
        //curveType: 'function',
        width: 400,
        height: 400,
        chartArea: {left: '10%', width: '85%', height: '85%'},
        series: {
          0: {color: '#36c'},
        },
      };

      /**
       * Visualize the graph of y = f(x) using Google Chart Tools.
       * For more documentation on Google Chart Tools, see this linechart example:
       * https://developers.google.com/chart/interactive/docs/gallery/linechart
       */
      Graph.drawVisualization = function () {
        var formulas = javascript.javascriptGenerator.workspaceToCode(
          Graph.workspace,
        );
        if (formulas === Graph.oldFormulas_) {
          // No change in the formula, don't recompute.
          return;
        }
        Graph.oldFormulas_ = formulas;

        // Create and populate the data table.
        var data = google.visualization.arrayToDataTable(
          Graph.plot(formulas),
        );
        // Create and draw the visualization, passing in the data and options.
        new google.visualization.LineChart(
          document.getElementById('visualization'),
        ).draw(data, Graph.options_);
      };

      /**
       * Plot points on the functions y = f(x).
       * @param {!Array.<string>} codes JavaScript codes.
       * @returns {!Array.<!Array>} 2D Array of points on the graph.
       */
      Graph.plot = function (codes) {
        // Initialize a table with two column headings.
        var table = [['x', 'y']];
        // TODO: Improve range and scale of graph.
        for (var x = -10; x <= 10; x = Math.round((x + 0.1) * 10) / 10) {
          try {
            var y1;
            eval(codes);
          } catch (e) {
            y1 = NaN;
          }
          var row = [x];
          if (!isNaN(y1)) {
            row.push(Math.round(y1 * Math.pow(10, 14)) / Math.pow(10, 14));
          } else {
            row.push(null);
          }
          if (row.length > 1) {
            table.push(row);
          }
        }
        // If the table is empty, add a dummy row to prevent graph error.
        if (table.length === 1) {
          table.push([0, 0]);
        }
        return table;
      };

      /**
       * Force Blockly to resize into the available width.
       */
      Graph.resize = function () {
        var width = Math.max(window.innerWidth - 440, 250);
        document.getElementById('blocklyDiv').style.width = width + 'px';
        Blockly.svgResize(Graph.workspace);
      };

      /**
       * Initialize Blockly and the graph.  Called on page load.
       */
      Graph.init = function () {
        Graph.workspace = Blockly.inject('blocklyDiv', {
          collapse: false,
          disable: false,
          media: './node_modules/blockly/media/',
          toolbox: toolbox,
        });

        Blockly.serialization.workspaces.load(startBlocks, Graph.workspace);
        Graph.workspace.clearUndo();

        // When Blockly changes, update the graph.
        Graph.workspace.addChangeListener(Graph.drawVisualization);
        Graph.workspace.addChangeListener(Blockly.Events.disableOrphans);
        Graph.resize();

        // Muestra el primer ejemplo por defecto
        showExample(1);
      };
      
      // Función para controlar la visibilidad de los ejemplos
      function showExample(exampleNumber) {
          // Oculta todos los ejemplos
          const allExamples = document.querySelectorAll('.example');
          allExamples.forEach(el => el.classList.remove('active'));

          // Desactiva todos los botones de navegación
          const allButtons = document.querySelectorAll('.example-nav button');
          allButtons.forEach(btn => btn.classList.remove('active'));

          // Muestra el ejemplo seleccionado y activa su botón
          const selectedExample = document.getElementById(`example-${exampleNumber}`);
          const selectedButton = document.querySelector(`.example-nav button:nth-child(${exampleNumber})`);
          if (selectedExample && selectedButton) {
              selectedExample.classList.add('active');
              selectedButton.classList.add('active');
          }
      }

      // Función para iniciar el tutorial
      function startTutorial() {
          setTimeout(() => {
            introJs().start();
          }, 500);
      }

      window.addEventListener('load', Graph.init);
      window.addEventListener('resize', Graph.resize);
    </script>
  </body>
</html>