<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Blockly Demo: Graph</title>
    <script src="https://www.google.com/jsapi"></script>
    <script src="./node_modules/blockly/blockly_compressed.js"></script>
    <script src="./node_modules/blockly/blocks_compressed.js"></script>
    <script src="./node_modules/blockly/javascript_compressed.js"></script>
    <script src="./node_modules/blockly/msg/en.js"></script>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intro.js/7.2.0/introjs.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/intro.js/7.2.0/intro.min.js"></script>
    <style>
      .intro-image-container {
        display: none;
        width: 100%;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        box-sizing: border-box;
      }
      .intro-image-container img {
        width: 100%;
        height: auto;
        border: 2px solid #3498db;
        border-radius: 8px;
      }
    </style>
  </head>
  <body>
    <nav class="nav-dots">
        <ul>
            <li><a href="index.html" >1</a></li>
            <li><a href="teoria.html">2</a></li>
            <li><a href="grafico.html" class="active">3</a></li>
            <li><a href="aplicacion.html">4</a></li>
            <li><a href="evaluacion.html">5</a></li>
        </ul>
    </nav>
    <p>
      Programa la función que quieras representar en el área de la gráfica
    </p>
    <p>
      &rarr; Puedes usar las variables y los operadores matemáticos básicos.
    </p>

    <button onclick="startTutorial()" class="tutorial-btn">Iniciar Tutorial</button>

    <div id="tutorial-intro-container" class="intro-image-container" data-intro="¡Bienvenido al tutorial! Aquí te mostraremos las diferentes áreas de la interfaz." data-step="1">
        <img src="assets/blockly-tour.png" alt="Área de trabajo de Blockly">
        <p>
            1. **Caja de Herramientas:** Los bloques de programación están en el lado izquierdo.
            <br>2. **Área de Programación:** En el centro, es donde creas tu función.
            <br>3. **Área de la Gráfica:** En el lado derecho, donde ves el resultado de tu código.
        </p>
    </div>

    <table>
      <tr>
        <td id="blocklyTd">
          <div id="blocklyDiv" style="height: 400px" data-intro="En este espacio en blanco puedes arrastrar los bloques de la caja de herramientas, unirlos como piezas de LEGO y construir tu función." data-step="2"></div>
        </td>
        <td id="graphTd">
          <div id="visualization" style="width: 400px" data-intro="Cada vez que cambies tu función, la gráfica se actualizará automáticamente aquí. Puedes usar el mouse para hacer zoom o moverte." data-step="3"></div>
        </td>
      </tr>
    </table>

    <script>
      // Load the Google Chart Tools Visualization API and the chart package.
      if (typeof google == 'object') {
        google.load('visualization', '1', {packages: ['corechart']});
      } else {
        alert(
          "Unable to load Google's chart API.\n" +
            'Are you connected to the Internet?',
        );
      }

      // Define the toolbox
      const toolbox = {
        kind: 'categoryToolbox',
        contents: [
          {
            kind: 'category',
            name: 'Matemáticas, Valores y operadores',
            id: 'mathCategory',
            colour: '%{BKY_MATH_HUE}',
            contents: [
              {
                kind: 'block',
                type: 'math_number',
                fields: {
                  NUM: 123,
                },
              },
              {
                kind: 'block',
                type: 'math_arithmetic',
                inputs: {
                  A: {
                    shadow: {
                      type: 'math_number',
                      fields: {
                        NUM: 1,
                      },
                    },
                  },
                  B: {
                    shadow: {
                      type: 'math_number',
                      fields: {
                        NUM: 1,
                      },
                    },
                  },
                },
              },
              {
                kind: 'block',
                type: 'math_single',
                inputs: {
                  NUM: {
                    shadow: {
                      type: 'math_number',
                      fields: {
                        NUM: 9,
                      },
                    },
                  },
                },
              },
              {
                kind: 'block',
                type: 'math_trig',
                inputs: {
                  NUM: {
                    shadow: {
                      type: 'math_number',
                      fields: {
                        NUM: 45,
                      },
                    },
                  },
                },
              },
              {
                kind: 'block',
                type: 'math_constant',
              },
              {
                kind: 'block',
                type: 'math_atan2',
                inputs: {
                  X: {
                    shadow: {
                      type: 'math_number',
                      fields: {
                        NUM: 1,
                      },
                    },
                  },
                  Y: {
                    shadow: {
                      type: 'math_number',
                      fields: {
                        NUM: 1,
                      },
                    },
                  },
                },
              },
            ],
          },
          {
            kind: 'category',
            name: 'Variables',
            id: 'variablesCategory',
            colour: '%{BKY_VARIABLES_HUE}',
            contents: [
              {
                kind: 'block',
                type: 'graph_get_x',
              }
            ],
          },
          {
            kind: 'category',
            name: 'Logic',
            id: 'logicCategory',
            colour: '%{BKY_LOGIC_HUE}',
            contents: [
              {
                kind: 'block',
                type: 'logic_compare',
              },
              {
                kind: 'block',
                type: 'logic_operation',
              },
              {
                kind: 'block',
                type: 'logic_negate',
              },
              {
                kind: 'block',
                type: 'logic_boolean',
              },
              {
                kind: 'block',
                type: 'logic_ternary',
              },
            ],
          },
        ],
      };

      const startBlocks = {
        blocks: {
          blocks: [
            {
              kind: 'block',
              type: 'graph_set_y1',
              x: 100,
              y: 100,
              inputs: {
                VALUE: {
                  block: {
                    type: 'math_arithmetic',
                    fields: {
                      OP: 'POWER',
                    },
                    inputs: {
                      A: {
                        block: {
                          type: 'graph_get_x',
                          shadow: {
                            type: 'math_number',
                            fields: {
                              NUM: 1,
                            },
                          },
                        },
                      },
                      B: {
                        block: {
                          type: 'math_number',
                          fields: {
                            NUM: 2,
                          },
                          shadow: {
                            type: 'math_number',
                            fields: {
                              NUM: 1,
                            },
                          },
                        },
                      },
                    },
                  },
                },
              },
            },
          ],
        },
      };

      // Define the custom blocks and their JS generators.
      Blockly.defineBlocksWithJsonArray([
        {
          type: 'graph_get_x',
          message0: 'x',
          output: 'Number',
          colour: Blockly.Msg['VARIABLES_HUE'],
          tooltip: Blockly.Msg['VARIABLES_GET_TOOLTIP'],
          helpUrl: Blockly.Msg['VARIABLES_GET_HELPURL'],
        },
      ]);

      javascript.javascriptGenerator.forBlock['graph_get_x'] = function (
        block,
      ) {
        return ['x', javascript.Order.ATOMIC];
      };

      Blockly.defineBlocksWithJsonArray([
        {
          type: 'graph_set_y1',
          message0: 'y = %1',
          args0: [
            {
              type: 'input_value',
              name: 'VALUE',
              check: 'Number',
            },
          ],
          colour: Blockly.Msg['VARIABLES_HUE'],
          tooltip: Blockly.Msg['VARIABLES_SET_TOOLTIP'],
          helpUrl: Blockly.Msg['VARIABLES_SET_HELPURL'],
        },
      ]);

      javascript.javascriptGenerator.forBlock['graph_set_y1'] = function (
        block,
        generator,
      ) {
        block.setDeletable(false);
        var argument0 =
          generator.valueToCode(block, 'VALUE', javascript.Order.ASSIGNMENT) ||
          '0';
        return 'y1 = ' + argument0 + ';';
      };

      /**
       * Create a namespace for the application.
       */
      var Graph = {};

      /**
       * Main Blockly workspace.
       * @type {Blockly.WorkspaceSvg}
       */
      Graph.workspace = null;

      /**
       * Cached copy of the function string.
       * @type {?string}
       * @private
       */
      Graph.oldFormulas_ = null;

      /**
       * Drawing options for the Chart API.
       * @type {!Object}
       * @private
       */
      Graph.options_ = {
        //curveType: 'function',
        width: 400,
        height: 400,
        chartArea: {left: '10%', width: '85%', height: '85%'},
        series: {
          0: {color: '#36c'},
        },
      };

      /**
       * Visualize the graph of y = f(x) using Google Chart Tools.
       * For more documentation on Google Chart Tools, see this linechart example:
       * https://developers.google.com/chart/interactive/docs/gallery/linechart
       */
      Graph.drawVisualization = function () {
        var formulas = javascript.javascriptGenerator.workspaceToCode(
          Graph.workspace,
        );
        if (formulas === Graph.oldFormulas_) {
          // No change in the formula, don't recompute.
          return;
        }
        Graph.oldFormulas_ = formulas;

        // Create and populate the data table.
        var data = google.visualization.arrayToDataTable(
          Graph.plot(formulas),
        );
        // Create and draw the visualization, passing in the data and options.
        new google.visualization.LineChart(
          document.getElementById('visualization'),
        ).draw(data, Graph.options_);
      };

      /**
       * Plot points on the functions y = f(x).
       * @param {!Array.<string>} codes JavaScript codes.
       * @returns {!Array.<!Array>} 2D Array of points on the graph.
       */
      Graph.plot = function (codes) {
        // Initialize a table with two column headings.
        var table = [['x', 'y']];
        // TODO: Improve range and scale of graph.
        for (var x = -10; x <= 10; x = Math.round((x + 0.1) * 10) / 10) {
          try {
            var y1;
            eval(codes);
          } catch (e) {
            y1 = NaN;
          }
          var row = [x];
          if (!isNaN(y1)) {
            row.push(Math.round(y1 * Math.pow(10, 14)) / Math.pow(10, 14));
          } else {
            row.push(null);
          }
          if (row.length > 1) {
            table.push(row);
          }
        }
        // If the table is empty, add a dummy row to prevent graph error.
        if (table.length === 1) {
          table.push([0, 0]);
        }
        return table;
      };

      /**
       * Force Blockly to resize into the available width.
       */
      Graph.resize = function () {
        var width = Math.max(window.innerWidth - 440, 250);
        document.getElementById('blocklyDiv').style.width = width + 'px';
        Blockly.svgResize(Graph.workspace);
      };

      /**
       * Initialize Blockly and the graph.  Called on page load.
       */
      Graph.init = function () {
        Graph.workspace = Blockly.inject('blocklyDiv', {
          collapse: false,
          disable: false,
          media: './node_modules/blockly/media/',
          toolbox: toolbox,
        });

        Blockly.serialization.workspaces.load(startBlocks, Graph.workspace);
        Graph.workspace.clearUndo();

        // When Blockly changes, update the graph.
        Graph.workspace.addChangeListener(Graph.drawVisualization);
        Graph.workspace.addChangeListener(Blockly.Events.disableOrphans);
        Graph.resize();
      };
      
      // Función para iniciar el tutorial
      function startTutorial() {
          // Aseguramos que Intro.js se inicie después de que Blockly haya renderizado el toolbox
          setTimeout(() => {
            introJs().start();
          }, 500); // Pequeño retraso de 500ms
      }

      window.addEventListener('load', Graph.init);
      window.addEventListener('resize', Graph.resize);
    </script>
  </body>
</html>