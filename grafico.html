<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Blockly Demo: Graph</title>
    <script src="https://www.google.com/jsapi"></script>
   
    <!-- <script src="./node_modules/blockly/blockly_compressed.js"></script>
    <script src="./node_modules/blockly/blocks_compressed.js"></script>
    <script src="./node_modules/blockly/javascript_compressed.js"></script>
    <script src="./node_modules/blockly/msg/en.js"></script> -->
    <script src="https://unpkg.com/blockly@12.0.0/blockly_compressed.js"></script>
    <script src="https://unpkg.com/blockly@12.0.0/blocks_compressed.js"></script>
    <script src="https://unpkg.com/blockly@12.0.0/javascript_compressed.js"></script>
    <script src="https://unpkg.com/blockly@12.0.0/msg/es.js"></script>
   
    <script src="https://unpkg.com/@blockly/theme-modern@6.0.6/dist/index.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intro.js/7.2.0/introjs.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/intro.js/7.2.0/intro.min.js"></script>
  </head>
  <body>
    <div>
      <nav class="nav-dots">
        <ul>
          <li><a href="index.html" >1</a></li>
          <li><a href="teoria.html">2</a></li>
          <li><a href="grafico.html" class="active">3</a></li>
          <li><a href="aplicacion.html">4</a></li>
          <li><a href="evaluacion.html">5</a></li>
        </ul>
      </nav>
    </div>
    
    <div class="main-content">
      <div id="Titulo" class="titulo_parrafo">
        <p>
          Usa los bloques para conectar los elementos de una función.
        </p>
        <p>
          Encontraras lo necesario para realizar las funciones. ¡Diviertete!
        </p>
      </div>
    </div>
    
    <div class="center-container">
      <button onclick="startTutorial()" class="action-btn">Iniciar Tutorial</button>
    </div>
    
    <hr>
    <div class="examples-container">
      <h2>Ejemplos para practicar y comprender</h2>
      
      <div class="example-nav" data-intro="Usa estos botones para navegar entre los diferentes ejemplos. Observa cada uno y trata de replicarlo en el área de trabajo de Blockly." data-step="4">
          <button onclick="showExample(1)" class="active">1</button>
          <button onclick="showExample(2)">2</button>
          <button onclick="showExample(3)">3</button>
          <button onclick="showExample(4)">4</button>
          <button onclick="showExample(5)">5</button>
      </div>
      
      <div class="examples-content-wrapper">
          
          <div id="example-1" class="example">
            <table>
              <thead>
                <tr>
                  <th>Función</th>
                  <th>Bloques</th>
                  <th>Gráfica</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>
                    <div class="example-title">$$y = x - 2$$</div>
                  </td>
                  <td>
                    <div class="example-blocks">
                      <img src="assets/bloque_y=x-2.png"  alt="Bloques para y=x-2">
                    </div>
                  </td>
                  <td>
                    <div class="example-graph">
                      <img src="assets/grafica_y=x-2.png" height="65%" width="65%" alt="Gráfica para y=x-2">
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <div id="example-2" class="example active">
            <table>
              <thead>
                <tr>
                  <th>Función</th>
                  <th>Bloques</th>
                  <th>Gráfica</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>
                    <div class="example-title">$$y = x^2 + 5$$</div>
                  </td>
                  <td>
                    <div class="example-blocks">
                      <img src="assets/bloque_y=x^2+5.png" alt="Bloques para y=x^2+5">
                    </div>
                  </td>
                  <td>
                    <div class="example-graph">
                      <img src="assets/grafica_y=x^2+5.png" height="65%" width="65%" alt="Gráfica para y=x^2+5">
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          
          
          
          <div id="example-3" class="example">
            <table>
              <thead>
                <tr>
                  <th>Función</th>
                  <th>Bloques</th>
                  <th>Gráfica</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>
                    <div class="example-title">$$y = \sqrt{x}$$</div>
                  </td>
                  <td>
                    <div class="example-blocks">
                      <img src="assets/bloque_y=sqrtx.png" alt="Bloques para y=sqrt(x)">
                    </div>
                  </td>
                  <td>
                    <div class="example-graph">
                      <img src="assets/grafica_y=sqrtx.png" height="65%" width="65%" alt="Gráfica para y=sqrt(x)">
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <div id="example-4" class="example">
            <table>
              <thead>
                <tr>
                  <th>Función</th>
                  <th>Bloques</th>
                  <th>Gráfica</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>
                    <div class="example-title">$$y = x^3 + 2$$</div>
                  </td>
                  <td>
                    <div class="example-blocks">
                      <img src="assets/bloque_y=x^3+2.png" alt="Bloques para y=x^3+2">
                    </div>
                  </td>
                  <td>
                    <div class="example-graph">
                      <img src="assets/grafica_y=x^3+2.png" height="65%" width="65%" alt="Gráfica para y=x^3+2">
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
      </div>
      <div id="example-5" class="example">
        <table>
          <thead>
            <tr>
              <th>Función</th>
              <th>Bloques</th>
              <th>Gráfica</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>
                <div class="example-title">$$y = \frac{2}{3}x + 1$$</div>
              </td>
              <td>
                <div class="example-blocks">
                  <img src="assets/bloque_y=23x+1.png" alt="Bloques para y=2/3x+1">
                </div>
              </td>
              <td>
                <div class="example-graph">
                  <img src="assets/grafica_y=23x+1.png" height="65%" width="65%" alt="Gráfica para y=2/3x+1">
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    
    <!---------------------------------Espacio para el area de trabajo de bloques y grafica-------------------------->
    <div id="functionDisplay" class="function-display">
    </div>

    <div class="blockly-and-graph-container">
      <div id="blocklyDiv" style="height: 400px;" data-intro="En este espacio puedes arrastrar y unir los bloques de la caja de herramientas para construir tu función." data-step="2"></div>
      <div id="visualization" style="width: 400px;" data-intro="Aquí se mostrará la gráfica de la función que programes. ¡Verás los resultados en tiempo real!" data-step="3"></div>
    </div>
    
    <!------------------------------------------Espacio para cargar los graficas----------------------------------------->
    <script>
      // Carga Google Chart Tools Visualizar API y la grafica.
      if (typeof google == 'object') {
        google.load('visualization', '1', {packages: ['corechart']});
      } else {
        alert(
          "No se puede cargarGoogle's chart API.\n" +
            '¿Tienes conexión a internet?',
        );
      }

    /*------------------------Espacio para la definición del toolbox --------------------------------*/
      const toolbox = {
        kind: 'categoryToolbox',
        contents: [
          {
            kind: 'category',
            name: 'Matemáticas, Valores y operadores',
            id: 'mathCategory',
            colour: '%{BKY_MATH_HUE}',
            contents: [
              {
                kind: 'block',
                type: 'math_number',
                fields: {
                  NUM: 123,
                },
              },
              {
                kind: 'block',
                type: 'math_arithmetic',
                inputs: {
                  A: {
                    shadow: {
                      type: 'math_number',
                      fields: {
                        NUM: 1,
                      },
                    },
                  },
                  B: {
                    shadow: {
                      type: 'math_number',
                      fields: {
                        NUM: 1,
                      },
                    },
                  },
                },
              },
              {
                kind: 'block',
                type: 'math_single',
                inputs: {
                  NUM: {
                    shadow: {
                      type: 'math_number',
                      fields: {
                        NUM: 9,
                      },
                    },
                  },
                },
              },
              {
                kind: 'block',
                type: 'math_trig',
                inputs: {
                  NUM: {
                    shadow: {
                      type: 'math_number',
                      fields: {
                        NUM: 45,
                      },
                    },
                  },
                },
              },
              {
                kind: 'block',
                type: 'math_constant',
              },
              {
                kind: 'block',
                type: 'math_atan2',
                inputs: {
                  X: {
                    shadow: {
                      type: 'math_number',
                      fields: {
                        NUM: 1,
                      },
                    },
                  },
                  Y: {
                    shadow: {
                      type: 'math_number',
                      fields: {
                        NUM: 1,
                      },
                    },
                  },
                },
              },
              {
                kind: 'block',
                type: 'math_fraction',
              },
            ],
          },
          {
            kind: 'category',
            name: 'Variables',
            id: 'variablesCategory',
            colour: '%{BKY_VARIABLES_HUE}',
            contents: [
              {
                kind: 'block',
                type: 'graph_get_x',
              }
            ],
          },
          {
            kind: 'category',
            name: 'Logic',
            id: 'logicCategory',
            colour: '%{BKY_LOGIC_HUE}',
            contents: [
              {
                kind: 'block',
                type: 'logic_compare',
              },
              {
                kind: 'block',
                type: 'logic_operation',
              },
              {
                kind: 'block',
                type: 'logic_negate',
              },
              {
                kind: 'block',
                type: 'logic_boolean',
              },
              {
                kind: 'block',
                type: 'logic_ternary',
              },
            ],
          },
        ],
      };

      const startBlocks = {
        blocks: {
          blocks: [
            {
              kind: 'block',
              type: 'graph_set_y1',
              x: 100,
              y: 100,
              inputs: {
                VALUE: {
                  block: {
                    type: 'math_arithmetic',
                    fields: {
                      OP: 'POWER',
                    },
                    inputs: {
                      A: {
                        block: {
                          type: 'graph_get_x',
                          shadow: {
                            type: 'math_number',
                            fields: {
                              NUM: 1,
                            },
                          },
                        },
                      },
                      B: {
                        block: {
                          type: 'math_number',
                          fields: {
                            NUM: 2,
                          },
                          shadow: {
                            type: 'math_number',
                            fields: {
                              NUM: 1,
                            },
                          },
                        },
                      },
                    },
                  },
                },
              },
            },
          ],
        },
      };

      // Define the custom blocks and their JS generators.
      Blockly.defineBlocksWithJsonArray([
        {
          type: 'graph_get_x',
          message0: 'x',
          output: 'Number',
          colour: Blockly.Msg['VARIABLES_HUE'],
          tooltip: Blockly.Msg['VARIABLES_GET_TOOLTIP'],
          helpUrl: Blockly.Msg['VARIABLES_GET_HELPURL'],
        },
      ]);

      javascript.javascriptGenerator.forBlock['graph_get_x'] = function (
        block,
      ) {
        return ['x', javascript.Order.ATOMIC];
      };

      Blockly.defineBlocksWithJsonArray([
        {
          type: 'graph_set_y1',
          message0: 'y = %1',
          args0: [
            {
              type: 'input_value',
              name: 'VALUE',
              check: 'Number',
            },
          ],
          colour: Blockly.Msg['VARIABLES_HUE'],
          tooltip: Blockly.Msg['VARIABLES_SET_TOOLTIP'],
          helpUrl: Blockly.Msg['VARIABLES_SET_HELPURL'],
        },
      ]);

      javascript.javascriptGenerator.forBlock['graph_set_y1'] = function (
        block,
        generator,
      ) {
        block.setDeletable(false);
        var argument0 =
          generator.valueToCode(block, 'VALUE', javascript.Order.ASSIGNMENT) ||
          '0';
        return 'y1 = ' + argument0 + ';';
      };

      // Nuevo bloque para fracciones
      Blockly.defineBlocksWithJsonArray([
        {
          type: 'math_fraction',
          message0: 'fracción %1 / %2',
          args0: [
            {
              type: 'input_value',
              name: 'NUMERATOR',
              check: 'Number',
            },
            {
              type: 'input_value',
              name: 'DENOMINATOR',
              check: 'Number',
            },
          ],
          output: 'Number',
          colour: Blockly.Msg['MATH_HUE'],
          tooltip: 'Calcula el valor de una fracción.',
          helpUrl: '',
        },
      ]);

      javascript.javascriptGenerator.forBlock['math_fraction'] = function (block, generator) {
        var numerator = generator.valueToCode(block, 'NUMERATOR', javascript.Order.DIVISION) || '0';
        var denominator = generator.valueToCode(block, 'DENOMINATOR', javascript.Order.DIVISION) || '0';
        var code = '(' + numerator + ' / ' + denominator + ')';
        return [code, javascript.Order.DIVISION];
      };

      /**
 * Traduce el código JavaScript de Blockly a una ecuación matemática en LaTeX.
 * @param {string} code El código JavaScript generado por Blockly.
 * @returns {string} La ecuación en formato LaTeX.
 */
function formatAsLatex(code) {
  // Elimina "y1 = " y el punto y coma del inicio y final del código
  let latexCode = code.replace(/^y1\s*=\s*/, '').replace(/;$/, '');

  // Reemplaza las funciones comunes de JS por su equivalente en LaTeX
  latexCode = latexCode.replace(/Math.pow\(([^,]+),\s*2\)/g, '$1^2');
  latexCode = latexCode.replace(/Math.pow\(([^,]+),\s*3\)/g, '$1^3');
  latexCode = latexCode.replace(/Math.sqrt\((.*?)\)/g, '\\sqrt{$1}');
  
  // Reemplaza los bloques de fracción personalizados (num / den) por LaTeX
  latexCode = latexCode.replace(/\((\d+)\s*\/\s*(\d+)\)/g, '\\frac{$1}{$2}');
  
  return `$$y = ${latexCode}$$`;
}

/**
 * Obtiene el código de Blockly, lo formatea y lo muestra en la página.
 */
function updateFunctionDisplay() {
  const code = javascript.javascriptGenerator.workspaceToCode(Graph.workspace);
  const latex = formatAsLatex(code);
  const displayElement = document.getElementById('functionDisplay');
  displayElement.innerHTML = latex;
  // Vuelve a renderizar la ecuación con MathJax
  MathJax.typesetPromise([displayElement]);
}








      /**
       * Create a namespace for the application.
       */
      var Graph = {};

      /**
       * Main Blockly workspace.
       * @type {Blockly.WorkspaceSvg}
       */
      Graph.workspace = null;

      /**
       * Cached copy of the function string.
       * @type {?string}
       * @private
       */
      Graph.oldFormulas_ = null;

      /**
       * Drawing options for the Chart API.
       * @type {!Object}
       * @private
       */
      Graph.options_ = {
        //curveType: 'function',
        width: 400,
        height: 400,
        chartArea: {left: '10%', width: '85%', height: '85%'},
        series: {
          0: {color: '#36c'},
        },
      };

      /**
       * Visualize the graph of y = f(x) using Google Chart Tools.
       * For more documentation on Google Chart Tools, see this linechart example:
       * https://developers.google.com/chart/interactive/docs/gallery/linechart
       */
      Graph.drawVisualization = function () {
        var formulas = javascript.javascriptGenerator.workspaceToCode(
          Graph.workspace,
        );
        if (formulas === Graph.oldFormulas_) {
          // No change in the formula, don't recompute.
          return;
        }
        Graph.oldFormulas_ = formulas;

        // Create and populate the data table.
        var data = google.visualization.arrayToDataTable(
          Graph.plot(formulas),
        );
        // Create and draw the visualization, passing in the data and options.
        new google.visualization.LineChart(
          document.getElementById('visualization'),
        ).draw(data, Graph.options_);
      };

      /**
       * Plot points on the functions y = f(x).
       * @param {!Array.<string>} codes JavaScript codes.
       * @returns {!Array.<!Array>} 2D Array of points on the graph.
       */
      Graph.plot = function (codes) {
        // Initialize a table with two column headings.
        var table = [['x', 'y']];
        // TODO: Improve range and scale of graph.
        for (var x = -10; x <= 10; x = Math.round((x + 0.1) * 10) / 10) {
          try {
            var y1;
            eval(codes);
          } catch (e) {
            y1 = NaN;
          }
          var row = [x];
          if (!isNaN(y1)) {
            row.push(Math.round(y1 * Math.pow(10, 14)) / Math.pow(10, 14));
          } else {
            row.push(null);
          }
          if (row.length > 1) {
            table.push(row);
          }
        }
        // If the table is empty, add a dummy row to prevent graph error.
        if (table.length === 1) {
          table.push([0, 0]);
        }
        return table;
      };

      /**
       * Force Blockly to resize into the available width.
       */
      Graph.resize = function () {
        //var width = Math.max(window.innerWidth - 440, 250);
        //document.getElementById('blocklyDiv').style.width = width + 'px';
        Blockly.svgResize(Graph.workspace);
      };

      /**
       * Initialize Blockly and the graph.  Called on page load.
       */
      Graph.init = function () {
        Graph.workspace = Blockly.inject('blocklyDiv', {
          collapse: false,
          disable: false,
          media: './node_modules/blockly/media/',
          toolbox: toolbox,
          theme: Blockly.Theme.Modern,
          renderer: 'zelos',
        });

        Blockly.serialization.workspaces.load(startBlocks, Graph.workspace);
        Graph.workspace.clearUndo();

        // When Blockly changes, update the graph.
        Graph.workspace.addChangeListener(Graph.drawVisualization);
         // Esta línea es la que escucha los cambios en los bloques.
        Graph.workspace.addChangeListener(updateFunctionDisplay); 
        Graph.workspace.addChangeListener(Blockly.Events.disableOrphans);
        Graph.resize();
        //formula a latex
        updateFunctionDisplay();
        // Muestra el primer ejemplo por defecto
        showExample(1);
      };
      
      // Función para controlar la visibilidad de los ejemplos
      function showExample(exampleNumber) {
          // Oculta todos los ejemplos
          const allExamples = document.querySelectorAll('.example');
          allExamples.forEach(el => el.classList.remove('active'));

          // Desactiva todos los botones de navegación
          const allButtons = document.querySelectorAll('.example-nav button');
          allButtons.forEach(btn => btn.classList.remove('active'));

          // Muestra el ejemplo seleccionado y activa su botón
          const selectedExample = document.getElementById(`example-${exampleNumber}`);
          const selectedButton = document.querySelector(`.example-nav button:nth-child(${exampleNumber})`);
          if (selectedExample && selectedButton) {
              selectedExample.classList.add('active');
              selectedButton.classList.add('active');
          }
      }

      // Función para iniciar el tutorial
      function startTutorial() {
          setTimeout(() => {
            introJs().start();
          }, 500);
      }












      window.addEventListener('load', Graph.init);
      window.addEventListener('resize', Graph.resize);
    </script>
  </body>
</html>